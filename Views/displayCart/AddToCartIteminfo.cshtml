@model List<Foodie.Models.customers.CartItemViewModel>

@{
    ViewData["Title"] = "Add To Cart";
    decimal grandTotal = 0;
    string couponeCode = ViewBag.CouponCode as string;
    decimal discountamount = ViewBag.Discount ?? 0;
    string successmessage = TempData["successmessage"] as string;
}

@{
    Layout = "~/Views/Shared/_foodieheader.cshtml";
}

<style>
    .modal {
        background: rgba(0, 0, 0, 0.5);
    }

    .modal-backdrop {
        display: none;
    }

    .coupon-list .card {
        border: 1px solid #ffcc00;
        background: #fff8e1;
        border-radius: 10px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
    }

    .coupon-list .btn-outline-primary {
        font-size: 14px;
        padding: 5px 10px;
    }

</style>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

<!-- MODAL: Dal Kachori -->
<div class="modal fade" id="foodModal1" tabindex="-1" aria-labelledby="foodModal1Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Dal Kachori [2 Pieces]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="https://luniamarketing.com/wp-content/uploads/2021/01/Moong-Dal-Ki-Kachori.jpg" class="img-fluid rounded" alt="Dal Kachori">
                <p class="mt-2 text-muted">Delicious crispy Dal Kachori with perfect spices.</p>
                <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-outline-danger">-</button>
                    <span class="fs-5">1</span>
                    <button class="btn btn-outline-primary">+</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: Naylon Khaman -->
<div class="modal fade" id="foodModal2" tabindex="-1" aria-labelledby="foodModal2Label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold">Naylon Khaman [1 KG]</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img src="https://modernasopalav.com/assets/images/recipe-image/nylon-khaman.png" class="img-fluid rounded" alt="Naylon Khaman">
                <p class="mt-2 text-muted">Soft and fluffy Naylon Khaman made from gram flour.</p>
                <div class="d-flex justify-content-center gap-3">
                    <button class="btn btn-outline-danger">-</button>
                    <span class="fs-5">1</span>
                    <button class="btn btn-outline-primary">+</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Update</button>
            </div>
        </div>
    </div>
</div>


<hr />
<div class="container mt-4">
    <div class="row">
        <!-- Left Section -->
        <div class="col-md-8">
            <!-- Logged In User -->
            <div class="card p-3 mb-3">
                <h5>Logged in <span class="text-success">✔</span></h5>
                <p>Keyur Prajapati | 9725802229</p>
            </div>

            <!-- Delivery Address -->
            <div class="card p-3 mb-3">
                <h5>Add a delivery address</h5>
                <p>You seem to be in the new location</p>

                <!-- Add Address Button -->
                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addressModal">
                    Add New Address
                </button>
            </div>

            <!-- Payment Section -->
            <div class="card p-3">
                <h3 class="text-uppercase">Payment</h3>
                <button class="btn btn-primary">Pay Now</button>
            </div>
        </div>

        <!-- Right Section (Order Summary) -->
        <div class="col-md-4">
            <div class="card p-3">
                <h5>Roof 5</h5>
                <p class="text-muted">Chhindwara Locality</p>

                <!-- Loop Through Cart Items -->
                @foreach (var item in Model)
                {
                    <div class="p-2 bg-dark">
                        <div class="menu-item" data-price="@item.amount">
                            <img src="data:image/png;base64,@Convert.ToBase64String(item.menu_img)" alt="@item.menu_name" style="width:150px; height:100px; object-fit:cover;" />
                            <div>
                                <h2>@item.menu_name</h2>
                                <p>Price: ₹<span class="unit-price">@item.amount</span></p>

                                <div class="d-flex gap-2 align-items-center">
                                    <button class="btn btn-outline-secondary qty-minus">-</button>
                                    <span class="qty">1</span>
                                    <button class="btn btn-outline-secondary qty-plus">+</button>
                                    <span class="item-total text-primary fw-bold ms-3">₹@item.amount</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <a asp-controller="Restaurantdeatil" asp-action="Restuarantinfo" class="float-end">Add More Item</a>

                <hr>

                <!-- No Contact Delivery -->
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="noContactDelivery">
                    <label class="form-check-label" for="noContactDelivery">
                        Opt-in for No-contact Delivery
                    </label>
                </div>

                <hr>

                <!-- Apply Coupon -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#couponModal">
                    Apply Coupon
                </button>

                <hr>

                <!-- Bill Details -->
                @{
                    decimal itemTotal = Model.Sum(x => x.amount * x.quantity);
                    decimal deliveryFee = 77;
                    decimal extraDiscount = 20;
                    decimal finalAmount = itemTotal + deliveryFee - extraDiscount;
                }

                <h6>Bill Details</h6>
                <p>Item Total: ₹@itemTotal</p>
                <p>Delivery Fee: ₹@deliveryFee</p>
                <p>Extra discount: -₹@extraDiscount</p>

                <a href="#" class="text-danger">Add Tip</a>

                <hr>

                <h5 class="d-flex justify-content-between">
                    <span>To Pay</span>
                    <span>₹@finalAmount</span>
                </h5>

                <div class="alert alert-success text-center">
                    Savings of ₹@extraDiscount
                </div>

                <div class="alert alert-light">
                    <h6>Review your order and address details to avoid cancellations</h6>
                    <p>Note: This order is non-refundable if cancelled.</p>
                    <a href="#" class="text-danger">Read policy</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Coupon Modal -->
<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- Coupon Input Box -->
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Enter coupon code">
                    <button class="btn btn-warning">Apply</button>
                </div>

                <hr>

                <h5>Available Coupons</h5>

                <!-- Coupon List -->
                <div class="coupon-list">
                    <!-- Coupon 1 -->
                    <div class="card p-3 mb-2">
                        <strong>STEALDEAL</strong>
                        <p>Get <b>30% off</b> on orders above ₹149. Max discount: ₹75.</p>
                        <p>Expiry Date : <strong>03-04-2025</strong></p>
                        <button class="btn btn-sm btn-outline-primary">Apply Coupon</button>
                    </div>

                    <!-- Coupon 2 -->
                    <div class="card p-3 mb-2">
                        <strong>TRYNEW</strong>
                        <p>Get <b>20% off</b> on orders above ₹149. Max discount: ₹50.</p>
                        <p>Expiry Date : <strong>09-04-2025</strong></p>
                        <button class="btn btn-sm btn-outline-primary">Apply Coupon</button>
                    </div>

                    <!-- Coupon 3 -->
                    <div class="card p-3 mb-2">
                        <strong>APAYFEST</strong>
                        <p>Get up to <b>₹100 cashback</b> using Amazon Pay Balance. Min order ₹199.</p>
                        <p>Expiry Date : <strong>10-04-2025</strong></p>
                        <button class="btn btn-sm btn-outline-primary">Apply Coupon</button>
                    </div>

                    <!-- Coupon 4 -->
                    <div class="card p-3 mb-2">
                        <strong>AXIS30</strong>
                        <p>Get <b>30% discount</b> using Axis Bank Credit Cards. Min order ₹200.</p>
                        <p>Expiry Date : <strong>12-04-2025</strong></p>
                        <button class="btn btn-sm btn-outline-primary">Apply Coupon</button>
                    </div>

                    <!-- Coupon 5 -->
                    <div class="card p-3 mb-2">
                        <strong>HDFC25</strong>
                        <p>Get <b>30% discount</b> using HDFC Bank Credit Cards. Min order ₹200.</p>
                        <p>Expiry Date : <strong>05-04-2025</strong></p>
                        <button class="btn btn-sm btn-outline-primary">Apply Coupon</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" id="addressForm">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 class="modal-title" id="addressModalLabel">Save delivery address</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <!-- Google Map -->
                    <div id="map" style="width: 100%; height: 300px; border-radius: 10px; margin-bottom: 15px;"></div>
                    <input type="hidden" name="latitude" id="latitude" />
                    <input type="hidden" name="longitude" id="longitude" />
                    <input type="hidden" name="address" id="fullAddress" />

                    <!-- Country -->
                    <div class="mb-3">
                        <label for="country" class="form-label">Country</label>
                        <input type="text" id="country" name="country" value="India" class="form-control" readonly />
                    </div>

                    <!-- State -->
                    <div class="mb-3">
                        <label for="state" class="form-label">State</label>
                        <select name="stateId" id="state" class="form-control">
                            <option value="">-- Select State --</option>
                        </select> 
                    </div>

                    <!-- District -->
                    <div class="mb-3">
                        <label for="district" class="form-label">District</label>
                        <select name="districtId" id="district" class="form-control">
                            <option value="">-- Select District --</option>
                        </select>
                    </div>

                    <!-- City -->
                    <div class="mb-3">
                        <label for="city" class="form-label">City</label>
                        <select name="cityId" id="city" class="form-control">
                            <option value="">-- Select City --</option>
                        </select>
                    </div>

                    <!-- Address Inputs -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="door_no" class="form-label">Door / Flat No.</label>
                            <input type="text" id="door_no" name="door_no" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="area" class="form-label">Area</label>
                            <input type="text" id="area" name="area" class="form-control" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="landmark" class="form-label">Landmark</label>
                        <input type="text" id="landmark" name="landmark" class="form-control" />
                    </div>

                    <!-- Address Type Selection -->
                    <div class="mb-3">
                        <label class="form-label">Address Type</label><br />
                        <div class="btn-group" role="group" aria-label="Address Type selection">
                            <input type="radio" class="btn-check" name="addresses_type" id="home" value="home" autocomplete="off" checked />
                            <label class="btn btn-outline-primary" for="home">🏠 Home</label>

                            <input type="radio" class="btn-check" name="addresses_type" id="work" value="work" autocomplete="off" />
                            <label class="btn btn-outline-primary" for="work">💼 Work</label>

                            <input type="radio" class="btn-check" name="addresses_type" id="other" value="other" autocomplete="off" />
                            <label class="btn btn-outline-primary" for="other">📍 Other</label>
                        </div>
                    </div>

                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary w-100">SAVE ADDRESS & PROCEED</button>
                </div>
            </form>
        </div>
    </div>
</div>


<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicmlzaGk4MTAyIiwiYSI6ImNtOTFpbXpjeDAxZGwybHNjdjljdnlpZ2UifQ.lwfPOwA0QilljmyDYiUV6A'; // Replace with your token
    // var map = new mapboxgl.Map({
    //     container: 'map',
    //     style: 'mapbox://styles/mapbox/streets-v11',
    //     center: [72.8367104, 21.2140032], // Default location
    //     zoom: 12
    // });

    let map;
    let marker;

    $('#addressModal').on('shown.bs.modal', function () {
        if (!map) {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [72.8311, 21.1702], // Default: Surat
                zoom: 10
            });

            // Add zoom and rotation controls
            map.addControl(new mapboxgl.NavigationControl());

            // Click to drop pin
            map.on('click', function (e) {
                const lng = e.lngLat.lng;
                const lat = e.lngLat.lat;

                // Set hidden inputs
                $('#latitude').val(lat);
                $('#longitude').val(lng);

                // If marker exists, remove it
                if (marker) marker.remove();

                // Add new marker
                marker = new mapboxgl.Marker({ draggable: true })
                    .setLngLat([lng, lat])
                    .addTo(map);

                // On drag end, update lat/lng
                marker.on('dragend', function () {
                    const lngLat = marker.getLngLat();
                    $('#latitude').val(lngLat.lat);
                    $('#longitude').val(lngLat.lng);
                });
            });
        }
    });

    $(document).ready(function () {
        function updateTotal(container) {
            const price = parseFloat(container.data('price'));
            const qty = parseInt(container.find('.qty').text());
            const total = price * qty;
            container.find('.item-total').text('₹' + total.toFixed(2));
        }

        $('.qty-plus').click(function () {
            const parent = $(this).closest('.menu-item');
            const qtySpan = parent.find('.qty');
            let qty = parseInt(qtySpan.text());
            qtySpan.text(++qty);
            updateTotal(parent);
        });

        $('.qty-minus').click(function () {
            const parent = $(this).closest('.menu-item');
            const qtySpan = parent.find('.qty');
            let qty = parseInt(qtySpan.text());
            if (qty > 1) {
                qtySpan.text(--qty);
                updateTotal(parent);
            }
        });
        // Load all states on page load
        $.ajax({
            url: '/displayCart/GetAllStates',
            type: 'GET',
            success: function (states) {
                $('#state').empty().append('<option value="">-- Select State --</option>');
                $.each(states, function (i, state) {
                    $('#state').append(`<option value="${state.stateId}">${state.stateName}</option>`);
                });
            }
        });

        // State → District
        $('#state').change(function () {
            const stateId = $(this).val();
            $.ajax({
                url: '/displayCart/GetDistricts',
                type: 'GET',
                data: { stateId: stateId },
                success: function (districts) {
                    $('#district').empty().append('<option value="">-- Select District --</option>');
                    $.each(districts, function (i, district) {
                        $('#district').append(`<option value="${district.districtId}">${district.disrictName}</option>`);
                    });
                }
            });
        });

        // District → City
        $('#district').change(function () {
            const districtId = $(this).val();
            $.ajax({
                url: '/displayCart/GetCities',
                type: 'GET',
                data: { districtId: districtId },
                success: function (cities) {
                    $('#city').empty().append('<option value="">-- Select City --</option>');
                    $.each(cities, function (i, city) {
                        $('#city').append(`<option value="${city.cityId}">${city.cityName}</option>`);
                    });
                }
            });
        });

         $('#addressForm').submit(function (e) {
            e.preventDefault();

            const address = `${$('#door_no').val()}, ${$('#area').val()}, ${$('#landmark').val()}`;
            $('#fullAddress').val(address);

            $.ajax({
                type: 'POST',
                url: '/displayCart/Address',
                data: $(this).serialize(),
                success: function (res) {
                    if (res.success) {
                        $('#addressModal').modal('hide');
                        alert('Address saved successfully!');
                        location.reload();
                    } else {
                        alert(res.message || 'Error saving address.');
                    }
                },
                error: function () {
                    alert('An error occurred.');
                }
            });
        });
    });  
</script>