@model List<Foodie.Models.customers.CartItemViewModel>

@{
    ViewData["Title"] = "Add To Cart";
    decimal grandTotal = 0;
    string couponeCode = ViewBag.CouponCode as string;
    decimal discountamount = ViewBag.Discount ?? 0;
    string successmessage = TempData["successmessage"] as string;
}

@{
    var userName = Context.Session.GetString("UserName");
    var phone = Context.Session.GetString("UserPhone");
}

@{
    Layout = "~/Views/Shared/_foodieheader.cshtml";
}

<style>
    .modal {
        background: rgba(0, 0, 0, 0.5);
    }

    .modal-backdrop {
        display: none;
    }

    .coupon-list .card {
        border: 1px solid #ffcc00;
        background: #fff8e1;
        border-radius: 10px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
    }

    .coupon-list .btn-outline-primary {
        font-size: 14px;
        padding: 5px 10px;
    }

</style>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

<!-- Mapbox CSS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<!-- Mapbox JS -->
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>


<div class="container mt-4">
    <div class="row">
        <!-- Left Section -->
        <div class="col-md-8">
            <!-- Logged In User -->
            <div class="card p-3 mb-3">
                <h5>Logged in <span class="text-success">✔</span></h5>
                <p> Kevin@123 | +91 9745863219</p>
            </div>

            <!-- Delivery Address -->
            <div class="card p-3 mb-3">
                <h5>Add a delivery address</h5>
                <p>You seem to be in the new location</p>

                <!-- Add Address Button -->
                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addressModal">
                    Add New Address
                </button>
            </div>

            <!-- Payment Section -->
            <div class="card p-3">
                <h3 class="text-uppercase">Payment</h3>
                <button class="btn btn-primary">Pay Now</button>
            </div>
        </div>

        <!-- Right Section (Order Summary) -->
        <div class="col-md-4">
            <div class="card p-3">
                <h3>Foodie Tasky Food</h3>
                <p class="h5">Foodie Tasty - The Commoner's Kitchen'</p>

                <!-- Loop Through Cart Items -->
                @foreach (var item in Model)
                {
                    <div class="p-2" style="border: 3px solid #000; border-radius: 5px;margin: 3px 3px;">
                        <div class="menu-item" data-price="@item.amount">
                            <img src="data:image/png;base64,@Convert.ToBase64String(item.menu_img)" alt="@item.menu_name" style="width:350px; height:200px; object-fit:contain;" />
                            <div>
                                <h4>Food Name : <strong>@item.menu_name</strong></h4>
                                <h4>Price: <strong> ₹<span class="unit-price">@item.amount</span></strong></h4>

                                <div class="d-flex gap-2 align-items-center" style="border-top: 3px solid #333;">
                                    <div class="mt-2">
                                        <button class="btn btn-outline-danger qty-minus">-</button>
                                        <span class="qty">1</span>
                                        <button class="btn btn-outline-success qty-plus">+</button>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between" style="margin-top: 2px; margin-bottom: 2px; border-top: 3px solid #000;">
                                    <h5>Total Amount :- </h5>
                                    <span class="item-total text-primary fw-bold ms-3">₹@item.amount</span>
                                </div>
                            </div>
                        </div>
                    </div>
                }


                <a asp-controller="Restaurantdeatil" asp-action="Restuarantinfo" class="float-end">Add More Item</a>

                <hr>

                <!-- No Contact Delivery -->
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="noContactDelivery">
                    <label class="form-check-label" for="noContactDelivery">
                        Opt-in for No-contact Delivery
                    </label>
                </div>

                <hr>

                <!-- Apply Coupon -->
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#couponModal">
                    Apply Coupon
                </button>

                <hr>

                <!-- Bill Details -->
                @{
                    decimal itemTotal = Model.Sum(x => x.amount * x.quantity);
                    decimal deliveryFee = 77;
                    decimal extraDiscount = 20;
                    decimal finalAmount = itemTotal + deliveryFee - extraDiscount;
                }

                <h6>Bill Details</h6>
                <p>Item Total: ₹@itemTotal</p>
                <p>Delivery Fee: ₹@deliveryFee</p>
                <p>Extra discount: -₹@extraDiscount</p>

                <a href="#" class="text-danger">Add Tip</a>

                <hr>

                <h5 class="d-flex justify-content-between">
                    <span>To Pay</span>
                    <span>₹@finalAmount</span>
                </h5>

                <div class="alert alert-success text-center">
                    Savings of ₹@extraDiscount
                </div>

                <div class="alert alert-light">
                    <h6>Review your order and address details to avoid cancellations</h6>
                    <p>Note: This order is non-refundable if cancelled.</p>
                    <a href="#" class="text-danger">Read policy</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Coupon Modal -->
<div class="modal fade" id="couponModal" tabindex="-1" aria-labelledby="couponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">
                <!-- Coupon Input Box -->
                <div class="input-group mb-3">
                    <input type="text" class="form-control" placeholder="Enter coupon code">
                    <button class="btn btn-warning">Apply</button>
                </div>

                <hr>

                <h5>Available Coupons</h5>

                <!-- Coupon List -->
                <div class="coupon-list">
                    <!-- Coupon 1 -->
                    <div class="card p-3 mb-2">
                        <strong>STEALDEAL</strong>
                        <p>Get <b>30% off</b> on orders above ₹149. Max discount: ₹75.</p>
                        <p>Expiry Date : <strong>03-04-2025</strong></p>
                        <button class="btn btn-sm btn-outline-primary">Apply Coupon</button>
                    </div>

                    <!-- Coupon 2 -->
                    <div class="card p-3 mb-2">
                        <strong>TRYNEW</strong>
                        <p>Get <b>20% off</b> on orders above ₹149. Max discount: ₹50.</p>
                        <p>Expiry Date : <strong>09-04-2025</strong></p>
                        <button class="btn btn-sm btn-outline-primary">Apply Coupon</button>
                    </div>

                    <!-- Coupon 3 -->
                    <div class="card p-3 mb-2">
                        <strong>APAYFEST</strong>
                        <p>Get up to <b>₹100 cashback</b> using Amazon Pay Balance. Min order ₹199.</p>
                        <p>Expiry Date : <strong>10-04-2025</strong></p>
                        <button class="btn btn-sm btn-outline-primary">Apply Coupon</button>
                    </div>

                    <!-- Coupon 4 -->
                    <div class="card p-3 mb-2">
                        <strong>AXIS30</strong>
                        <p>Get <b>30% discount</b> using Axis Bank Credit Cards. Min order ₹200.</p>
                        <p>Expiry Date : <strong>12-04-2025</strong></p>
                        <button class="btn btn-sm btn-outline-primary">Apply Coupon</button>
                    </div>

                    <!-- Coupon 5 -->
                    <div class="card p-3 mb-2">
                        <strong>HDFC25</strong>
                        <p>Get <b>30% discount</b> using HDFC Bank Credit Cards. Min order ₹200.</p>
                        <p>Expiry Date : <strong>05-04-2025</strong></p>
                        <button class="btn btn-sm btn-outline-primary">Apply Coupon</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Address Modal -->
<div class="modal fade" id="addressModal" tabindex="-1" aria-labelledby="addressModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="addressForm" method="post" asp-action="Address">
                <div class="modal-header">
                    <h5 class="modal-title">Save delivery address</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">
                    <div id="map" style="width: 100%; height: 300px; border-radius: 10px; margin-bottom: 15px;"></div>
                    <input type="hidden" name="latitude" id="latitude" />
                    <input type="hidden" name="longitude" id="longitude" />
                    <input type="hidden" name="address" id="address" />


                    <div class="mb-3">
                        <label class="form-label">Country</label>
                        <input type="text" name="CountryName" class="form-control" value="India" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">State</label>
                        <select name="StateId" id="state" class="form-control">
                            <option value="">-- Select State --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">District</label>
                        <select name="DistrictId" id="district" class="form-control">
                            <option value="">-- Select District --</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">City</label>
                        <select name="CityId" id="city" class="form-control">
                            <option value="">-- Select City --</option>
                        </select>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Door</label>
                            <input type="text" id="door_no" name="door_no" class="form-control" />
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Area</label>
                            <input type="text" id="area" name="area" class="form-control" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Landmark</label>
                        <input type="text" id="landmark" name="landmark" class="form-control" />
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Address Type</label><br />
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="addresses_type" id="home" value="home" checked />
                            <label class="btn btn-outline-primary" for="home">🏠 Home</label>

                            <input type="radio" class="btn-check" name="addresses_type" id="work" value="work" />
                            <label class="btn btn-outline-primary" for="work">💼 Work</label>

                            <input type="radio" class="btn-check" name="addresses_type" id="other" value="other" />
                            <label class="btn btn-outline-primary" for="other">📍 Other</label>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary w-100">SAVE ADDRESS & PROCEED</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoicmlzaGk4MTAyIiwiYSI6ImNtOTFpbXpjeDAxZGwybHNjdjljdnlpZ2UifQ.lwfPOwA0QilljmyDYiUV6A'; // Replace with your token

    let map;
    let marker;

    $('#addressModal').on('shown.bs.modal', function () 
    {
        if (!map) 
        {
            map = new mapboxgl.Map(
                {
                container: 'map',
                style: 'mapbox://styles/mapbox/streets-v11',
                center: [72.8311, 21.1702], // Default: Surat
                zoom: 10
            });

            // Add zoom and rotation controls
            map.addControl(new mapboxgl.NavigationControl());

            // Click to drop pin
            map.on('click', function (e) {
                const lng = e.lngLat.lng;
                const lat = e.lngLat.lat;

                // Set hidden inputs
                $('#latitude').val(lat);
                $('#longitude').val(lng);

                // If marker exists, remove it
                if (marker) marker.remove();

                // Add new marker
                marker = new mapboxgl.Marker({ draggable: true })
                    .setLngLat([lng, lat])
                    .addTo(map);

                // On drag end, update lat/lng
                marker.on('dragend', function () 
                {

                    const lngLat = marker.getLngLat();
                    $('#latitude').val(lngLat.lat);
                    $('#longitude').val(lngLat.lng);
                });
                console.log(lng);
                console.log(lat);
            });
        }
    });


    $(document).ready(function () 
    {
        function updateTotal(container) {
            const price = parseFloat(container.attr('data-price'));
            const qty = parseInt(container.find('.qty').text());
            const total = price * qty;
            container.find('.item-total').text('₹' + total.toFixed(2));
        }

        // On page load: calculate all totals
        $('.menu-item').each(function () {
            updateTotal($(this));
        });

        // Plus button
        $('.qty-plus').click(function () {
            const parent = $(this).closest('.menu-item');
            const qtySpan = parent.find('.qty');
            let qty = parseInt(qtySpan.text());
            qtySpan.text(++qty);
            updateTotal(parent);
        });

        // Minus button
        $('.qty-minus').click(function () {
            const parent = $(this).closest('.menu-item');
            const qtySpan = parent.find('.qty');
            let qty = parseInt(qtySpan.text());
            if (qty > 1) {
                qtySpan.text(--qty);
                updateTotal(parent);
            }
        });

        // Load all states on page load
        $.ajax({
            url: '/displayCart/GetAllStates',
            type: 'GET',
            success: function (states) {
                $('#state').empty().append('<option value="">-- Select State --</option>');
                $.each(states, function (i, state) {
                    $('#state').append(`<option value="${state.stateId}">${state.stateName}</option>`);
                    console.log(state);
                });
            }
        });

        // State → District
        $('#state').change(function () {
            const stateId = $(this).val();
            $.ajax({
                url: '/displayCart/GetDistricts',
                type: 'GET',
                data: { stateId: stateId },
                success: function (districts) {
                    $('#district').empty().append('<option value="">-- Select District --</option>');
                    $.each(districts, function (i, district) {
                        $('#district').append(`<option value="${district.districtId}">${district.disrictName}</option>`);
                        console.log(district);
                    });
                }
            });
        });

        // District → City
        $('#district').change(function () {
            const districtId = $(this).val();
            $.ajax({
                url: '/displayCart/GetCities',
                type: 'GET',
                data: { districtId: districtId },
                success: function (cities) {
                    $('#city').empty().append('<option value="">-- Select City --</option>');
                    $.each(cities, function (i, city) {
                        $('#city').append(`<option value="${city.cityId}">${city.cityName}</option>`);
                        console.log(city);
                    });
                }
            });
        });

        $('#addressForm').on('submit', function (e) {
            e.preventDefault();

            var form = $(this);
            var formData = form.serializeArray(); // get the form data as array

            // Manually add values that are NOT in the form or dynamically added
            formData.push(
                { name: "latitude", value: $('#latitude').val() },
                { name: "longitude", value: $('#longitude').val() },
                { name: "address", value: $('#address').val() }
            );

            console.log(document.querySelector('#latitude').value);
            console.log(document.querySelector('#longitude').value);
            console.log(document.querySelector('#address').value);


            $.ajax({
                type: "POST",
                url: form.attr('action'),
                data: $.param(formData), // serialize again after pushing
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        $('#addressModal').modal('hide');
                        form.trigger('reset');
                    } else {
                        alert("Error: " + response.message);
                    }
                },
                error: function () {
                    alert("Something went wrong while saving address.");
                }
            });
        });
    });
</script>