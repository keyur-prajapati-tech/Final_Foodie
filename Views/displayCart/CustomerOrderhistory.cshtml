@model List<Foodie.Models.customers.tbl_orders>

@{
    Layout = null;
    Func<string, string> GetStatusColor = status =>
    {
        return status.ToLower() switch
        {
            "paid" => "primary",
            "delivered" => "success",
            "pending" => "warning",
            "rejected" => "danger",
            "accepted" => "info",
            _ => "secondary"
        };
    };
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Your Orders</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .order-card {
            transition: all 0.3s ease;
            border-left: 4px solid;
        }

            .order-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            }

            .order-card.paid {
                border-left-color: #0d6efd;
            }

            .order-card.delivered {
                border-left-color: #198754;
            }

            .order-card.pending {
                border-left-color: #ffc107;
            }

            .order-card.rejected {
                border-left-color: #dc3545;
            }

            .order-card.accepted {
                border-left-color: #0dcaf0;
            }

        .item-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
        }

        .timeline {
            position: relative;
            padding-left: 1rem;
        }

        .timeline-step {
            position: relative;
            padding-left: 2rem;
            padding-bottom: 2rem;
        }

            .timeline-step:last-child {
                padding-bottom: 0;
            }

            .timeline-step::before {
                content: '';
                position: absolute;
                left: 0.5rem;
                top: 0;
                bottom: 0;
                width: 2px;
                background-color: #e9ecef;
            }

            .timeline-step.completed::before {
                background-color: #198754;
            }

            .timeline-step.active::before {
                background-color: #0d6efd;
            }

        .timeline-content {
            position: relative;
        }

        .inner-circle {
            position: absolute;
            left: -2rem;
            top: 0.25rem;
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            background-color: #e9ecef;
            border: 3px solid white;
        }

        .timeline-step.completed .inner-circle {
            background-color: #198754;
        }

        .timeline-step.active .inner-circle {
            background-color: #0d6efd;
            animation: pulse 1.5s infinite;
        }

        @@keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(13, 110, 253, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(13, 110, 253, 0);
            }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            margin-top: 2rem;
        }

        .empty-state-icon {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Filters -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex gap-2">
                <select class="form-select" style="width: 180px;">
                    <option>All Status</option>
                    <option>Delivered</option>
                    <option>Pending</option>
                    <option>Rejected</option>
                    <option>Paid</option>
                    <option>Accepted</option>
                </select>
                <select class="form-select" style="width: 150px;">
                    <option>Last 30 Days</option>
                    <option>Last 6 Months</option>
                    <option>This Year</option>
                </select>
            </div>
            <h4 class="mb-0"><i class="bi bi-box-seam"></i> Your Orders</h4>
        </div>

        @if (Model == null || Model.Count == 0)
        {
            <!-- Empty state -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="bi bi-cart-x"></i>
                </div>
                <h3>No Orders Found</h3>
                <p class="text-muted">You haven't placed any orders yet. When you do, they'll appear here.</p>
                <a href="@Url.Action("Index", "Home")" class="btn btn-primary mt-3">
                    <i class="bi bi-arrow-left"></i> Continue Shopping
                </a>
            </div>
        }
        else
        {
            <!-- Orders List -->
            foreach (var order in Model)
            {
                <div class="card shadow-sm mb-4 order-card @order.order_status.ToLower()">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>Order Placed:</strong> @order.order_date.ToString("dd MMM yyyy")<br />
                                <strong>Total:</strong> ₹@order.grand_total
                            </div>
                            <div class="text-end">
                                <strong>Order ID:</strong> @order.order_id<br />
                                <span class="badge bg-@GetStatusColor(order.order_status)">
                                    @order.order_status
                                </span>
                            </div>
                        </div>

                        <hr />

                        @foreach (var item in order.OrderItems)
                        {
                            <div class="d-flex mb-3">
                                <div class="me-3">
                                    @if (item.menu_img != null)
                                    {
                                        <img src="data:image/jpeg;base64,@Convert.ToBase64String(item.menu_img)"
                                             class="img-thumbnail item-img" />
                                    }
                                    else
                                    {
                                        <div class="item-img bg-light d-flex align-items-center justify-content-center">
                                            <i class="bi bi-image text-muted"></i>
                                        </div>
                                    }
                                </div>
                                <div class="flex-grow-1">
                                    <h6>@item.menu_name</h6>
                                    <p>Qty: @item.quantity × ₹@item.list_price</p>
                                    <strong>₹@(item.quantity * item.list_price)</strong>
                                </div>
                                <div class="text-end">
                                    <!-- Rate button - only for delivered orders -->
                                    @if (order.order_status.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-outline-primary btn-sm mb-2 rate-btn"
                                                data-bs-toggle="modal"
                                                data-bs-target="#ratingModal"
                                                data-order-id="@order.order_id"
                                                data-menu-id="@item.menu_id"
                                                data-menu-name="@item.menu_name"
                                                data-customer-id="@order.customer_id"
                                                data-restaurant-id=8>
                                            <i class="bi bi-star-fill"></i> Rate
                                        </button>
                                    }
                                </div>
                            </div>
                        }

                        <div class="d-flex justify-content-between align-items-center">
                            <div class="action-buttons">
                                <!-- Download Bill - only for paid or delivered orders -->
                                @if (order.order_status.Equals("Paid", StringComparison.OrdinalIgnoreCase) ||
                               order.order_status.Equals("Delivered", StringComparison.OrdinalIgnoreCase))
                                {
                                    <button class="btn btn-sm btn-success me-2" onclick="generateBill(@order.order_id)">
                                        <i class="bi bi-download"></i> Download Bill
                                    </button>
                                }

                                <!-- Track button - only for delivered or accepted orders -->
                                @if (order.order_status.Equals("Delivered", StringComparison.OrdinalIgnoreCase) ||
                               order.order_status.Equals("Accepted", StringComparison.OrdinalIgnoreCase))
                                {
                                    <button class="btn btn-sm btn-outline-secondary me-2 rate-btn" data-bs-toggle="modal"
                                            data-bs-target="#trackingModal">
                                        <i class="bi bi-geo-alt"></i> Track
                                    </button>
                                }

                                <!-- Cancel button - only for pending orders -->
                                @if (order.order_status.Equals("Pending", StringComparison.OrdinalIgnoreCase))
                                {
                                    <button class="btn btn-sm btn-outline-danger me-2">
                                        <i class="bi bi-x-circle"></i> Cancel
                                    </button>
                                }

                                @if (order.order_status.Equals("Pending", StringComparison.OrdinalIgnoreCase))
                                {
                                    <button class="btn btn-sm btn-outline-dark me-2">
                                        <i class="bi bi-circle"></i> Compliant
                                    </button>
                                }

                                <!-- Reorder button - for all statuses except rejected -->
                                @if (!order.order_status.Equals("Rejected", StringComparison.OrdinalIgnoreCase))
                                {
                                    <button class="btn btn-sm btn-outline-dark">
                                        <i class="bi bi-arrow-repeat"></i> Buy Again
                                    </button>
                                }

                                <!-- Feedback button - only for rejected orders -->
                                @if (order.order_status.Equals("Rejected", StringComparison.OrdinalIgnoreCase))
                                {
                                    <button class="btn btn-sm btn-outline-info">
                                        <i class="bi bi-chat-left-text"></i> Feedback
                                    </button>
                                }
                            </div>

                            <!-- Additional actions for accepted orders -->
                            @if (order.order_status.Equals("Accepted", StringComparison.OrdinalIgnoreCase))
                            {
                                <div>
                                    <button class="btn btn-sm btn-outline-warning">
                                        <i class="bi bi-clock-history"></i> Estimated: 30 mins
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    <!-- Rating Modal -->
    <div class="modal fade" id="ratingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rate <span id="menuName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="ratingForm">
                        <input type="hidden" id="customerId" name="CustomerId" />
                        <input type="hidden" id="restaurantId" name="RestaurantId" />
                        <input type="hidden" id="orderId" name="OrderId" />
                        <input type="hidden" id="menuId" name="MenuId" />

                        <div class="mb-3">
                            <label class="form-label">Rating</label>
                            <div class="star-rating">
                                <i class="bi bi-star-fill star" data-value="1"></i>
                                <i class="bi bi-star-fill star" data-value="2"></i>
                                <i class="bi bi-star-fill star" data-value="3"></i>
                                <i class="bi bi-star-fill star" data-value="4"></i>
                                <i class="bi bi-star-fill star" data-value="5"></i>
                            </div>
                            <input type="hidden" id="ratingValue" name="RatingValue" value="0" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Review</label>
                            <textarea class="form-control" id="reviewText" name="discription" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tracking Modal -->
    <div class="modal fade" id="trackingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Order Tracking</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Order Details</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled">
                                        <li><strong>Order ID:</strong> <span id="trackOrderId">#12345</span></li>
                                        <li><strong>Placed On:</strong> <span id="trackOrderDate">12 May 2024</span></li>
                                        <li><strong>Total Amount:</strong> <span id="trackOrderTotal">₹450.00</span></li>
                                        <li><strong>Payment Method:</strong> <span id="trackPaymentMethod">Credit Card</span></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Delivery Address</h6>
                                </div>
                                <div class="card-body">
                                    <address>
                                        <strong id="trackCustomerName">John Doe</strong><br>
                                        <span id="trackAddressLine1">123 Main Street</span><br>
                                        <span id="trackAddressLine2">Apt 4B</span><br>
                                        <span id="trackCityState">New York, NY 10001</span><br>
                                        <span id="trackPhone">Phone: (123) 456-7890</span>
                                    </address>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Delivery Status</h6>
                                </div>
                                <div class="card-body">
                                    <div class="timeline">
                                        <div class="timeline-step completed">
                                            <div class="timeline-content">
                                                <div class="inner-circle"></div>
                                                <p class="h6 mt-3 mb-1">Order Placed</p>
                                                <p class="text-muted mb-0">12 May, 10:30 AM</p>
                                            </div>
                                        </div>
                                        <div class="timeline-step completed">
                                            <div class="timeline-content">
                                                <div class="inner-circle"></div>
                                                <p class="h6 mt-3 mb-1">Order Confirmed</p>
                                                <p class="text-muted mb-0">12 May, 10:45 AM</p>
                                            </div>
                                        </div>
                                        <div class="timeline-step completed">
                                            <div class="timeline-content">
                                                <div class="inner-circle"></div>
                                                <p class="h6 mt-3 mb-1">Preparing Food</p>
                                                <p class="text-muted mb-0">12 May, 11:00 AM</p>
                                            </div>
                                        </div>
                                        <div class="timeline-step active">
                                            <div class="timeline-content">
                                                <div class="inner-circle"></div>
                                                <p class="h6 mt-3 mb-1">On the Way</p>
                                                <p class="text-muted mb-0">Expected by 12:30 PM</p>
                                            </div>
                                        </div>
                                        <div class="timeline-step">
                                            <div class="timeline-content">
                                                <div class="inner-circle"></div>
                                                <p class="h6 mt-3 mb-1">Delivered</p>
                                                <p class="text-muted mb-0">--</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="flex-shrink-0">
                                                <img src="https://via.placeholder.com/50" class="rounded-circle" width="50" height="50" alt="Driver">
                                            </div>
                                            <div class="flex-grow-1 ms-3">
                                                <h6 class="mb-0" id="trackDriverName">Robert Johnson</h6>
                                                <small class="text-muted">Your delivery partner</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary w-100">
                                            <i class="bi bi-telephone"></i> Call Driver
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">
                        <i class="bi bi-share"></i> Share Status
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts -->
    <script>
        $(document).ready(function() {
            // Star rating interaction
            $('.star-rating .star').on('click', function() {
                const value = $(this).data('value');
                $('#ratingValue').val(value);

                // Update star display
                $('.star-rating .star').each(function() {
                    if ($(this).data('value') <= value) {
                        $(this).addClass('text-warning');
                    } else {
                        $(this).removeClass('text-warning');
                    }
                });
            });

            // Set up modal with all required data
            $('#ratingModal').on('show.bs.modal', function (e) {
                var button = $(e.relatedTarget);
                $('#orderId').val(button.data('order-id'));
                $('#menuId').val(button.data('menu-id'));
                $('#menuName').text(button.data('menu-name'));
                $('#customerId').val(button.data('customer-id'));
                $('#restaurantId').val(button.data('restaurant-id'));

                // Reset form
                $('#ratingForm')[0].reset();
                $('.star-rating .star').removeClass('text-warning');
                $('#ratingValue').val('0');
            });

            // Handle form submission
            $('#ratingForm').submit(function (e) {
                e.preventDefault();

                if ($('#ratingValue').val() === '0') {
                    alert('Please select a rating');
                    return;
                }

                const data = {
                    CustomerId: $("#customerId").val(),
                    RestaurantId: $("#restaurantId").val(),
                    OrderId: $("#orderId").val(),
                    MenuId: $("#menuId").val(),
                    RatingValue: $("#ratingValue").val(),
                    discription: $("#reviewText").val()
                };

                $.ajax({
                    type: "POST",
                    url: "/displayCart/SubmitReview", // Update with your actual endpoint
                    data: JSON.stringify(data),
                    contentType: "application/json",
                    success: function (res) {
                        if (res.success) {
                            alert("Thank you for your review!");
                            $("#ratingModal").modal('hide');
                        } else {
                            alert(res.message || "Something went wrong. Please try again.");
                        }
                    },
                    error: function (err) {
                        alert("An error occurred. Please try again.");
                        console.error(err);
                    }
                });
            });

            // Tracking modal setup
            $('.btn-outline-secondary').filter(':contains("Track")').on('click', function() {
                // In a real implementation, you would fetch this data from the server
                // For now, we'll use dummy data
                const orderCard = $(this).closest('.order-card');
                const orderId = orderCard.find('.card-body .text-end strong:first').text().trim();
                const orderDate = orderCard.find('.card-body strong:contains("Order Placed:")').parent().text().replace('Order Placed:', '').trim();
                const orderTotal = orderCard.find('.card-body strong:contains("Total:")').parent().text().replace('Total:', '').trim();

                // Set the modal data
                $('#trackOrderId').text(orderId);
                $('#trackOrderDate').text(orderDate);
                $('#trackOrderTotal').text(orderTotal);

                // Show the modal
                $('#trackingModal').modal('show');
            });
        });

        function generateBill(orderId) {
            window.location.href = '@Url.Action("GenerateBill", "displayCart")?orderId=' + orderId;
        }

        // Filter functionality
        $('.form-select').change(function() {
            const statusFilter = $('.form-select').eq(0).val().toLowerCase();
            const timeFilter = $('.form-select').eq(1).val();

            $('.order-card').each(function() {
                const cardStatus = $(this).attr('class').match(/paid|delivered|pending|rejected|accepted/)[0];
                const showStatus = statusFilter === 'all status' || cardStatus === statusFilter;

                // Add time filter logic if needed
                $(this).toggle(showStatus);
            });
        });
    </script>
</body>
</html>